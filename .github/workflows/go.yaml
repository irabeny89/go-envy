name: Test
permissions:
  contents: write
  id-token: write
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Test
        run: go test ./...

      - name: Test with Race Detector
        run: go test -race ./...

      - name: Get Coverage
        run: go test -v -cover -coverprofile=coverage.out ./...

  version:
    name: Git Tag
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize Git Config
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}+github-actions@users.noreply.github.com"

      - name: Get Next Version
        uses: cocogitto/cocogitto-action@v3
        id: next-version
        with:
          dry-run: true
        continue-on-error: true

      - name: Update Version
        run: |
          git tag v"${{ steps.next-version.outputs.version }}"
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "chore: version bump to ${{ steps.next-version.outputs.version }}"
          fi

      - name: Push Committed Changes
        run: |
          if git rev-list --count --left-only @{upstream}...HEAD > /dev/null 2>&1; then
            git push origin main
          fi

      - name: Conventional Commit and Semver Release
        uses: cocogitto/cocogitto-action@v3
        id: release
        with:
          release: true
          git-user: "${{ github.actor }}"
          git-user-email: "${{ github.actor }}+github-actions@users.noreply.github.com"

      - name: Generate Github Release Changelog
        run: cog changelog --at ${{ steps.release.outputs.version }} -t full_hash > GITHUB_CHANGELOG.md

      - name: Upload Github Release
        id: gh-release
        uses: softprops/action-gh-release@v2
        with:
          body_path: GITHUB_CHANGELOG.md
          tag_name: ${{ steps.release.outputs.version }}
